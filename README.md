# SignalPollerEA 商业级量化交易系统 (2026版)

本项目包含针对四大核心资产类别（Crypto, Gold, Forex, Index）定制开发的 MT5 智能交易系统 (EA)。系统基于 CF Workers 信号推送架构，集成了针对 **Exness 高杠杆环境** 优化的 **三大风控体系** 及 **趋势回补机制**。

---

## 📂 四大板块 (Modules)

每个板块的 EA 均针对该品种的波动特性、点差成本和交易时段进行了参数微调。

| 板块 | 目录 | 适用资产 | 特性优化 | 典型周期 |
| :--- | :--- | :--- | :--- | :--- |
| **BTC (Crypto)** | `/btc` | BTCUSD, ETHUSD | **M15高频平衡策略**。针对币圈巨大的点差和极快的反转，采用了 2000 点的保本缓冲和 1.5% 的紧缩止损。 | M15 |
| **Gold (XAU)** | `/gold` | XAUUSD (黄金) | **趋势突破策略**。针对黄金"单边猛、回调深"的特点，设置了 200 点保本缓冲，防止被洗盘。 | H1 / M30 |
| **Forex (外汇)** | `/forex` | EURUSD, GBPUSD | **稳健剥头皮**。30 点微利保本，适合低点差直盘。 | M5 / M15 |
| **Index (指数)** | `/index` | US30, NAS100 | **日内波段**。100 点缓冲，适应美股开盘时的高波动和跳空风险。 | M15 / H1 |

---

## 🛡️ 核心风控与回补体系 (Risk & Re-Entry System)

本系统采用 **"防御-锁定-收割-接力"** 的四层递进防护网，特别针对 Exness 等高杠杆券商的 **零止损距离** 和 **滑点** 风险进行了深度适配。

### 1. 止损 (Stop Loss) —— 【防御】
**“底线思维，分层拦截”**

*   **第一层：硬止损 (Hard SL)** —— **灾难熔断器**
    *   **执行者**: 券商服务器 (Exness)。
    *   **机制**: 在开仓瞬间发送给券商服务器的绝对止损价。
    *   **BTC设置**: `5.0%`。故意放宽，作为**最后的防线**。仅在网络断连、VPS死机或行情瞬间崩盘（Flash Crash）时触发。
*   **第二层：软止损 (Soft SL)** —— **智能操盘手**
    *   **执行者**: EA 本地逻辑 (`OnTick`)。
    *   **机制**: 实时计算浮亏比例，触线即平。
    *   **策略**:
        *   **轻仓**: 允许 `1.5%` 回撤。
        *   **重仓** (Lot > 0.05): 自动收紧至 `1.0%`，加强本金保护。

### 2. 保本 (Break Even) —— 【锁定】
**“立于不败，成本覆盖”**

*   **触发时机**: 当浮盈达到 **1.2%** (与移动止盈启动同步)。
*   **核心黑科技 (ProtectBuffer)**:
    *   普通 EA 的保本是移到 `EntryPrice` (0)，但在 Exness 上扣除点差和佣金后其实是**亏钱**的。
    *   **本系统**: 将 SL 移到 `EntryPrice + ProtectBuffer`。
    *   **Exness 专用缓冲**:
        *   **BTC**: `2000 Points` ($20) —— 覆盖巨大点差。
        *   **Gold**: `200 Points` ($2.0) —— 覆盖点差与滑点。
    *   *结果：即使被打回原形，依然能覆盖手续费，实现**真·零风险**。*

### 3. 移动止盈 (Trailing Stop) —— 【收割】
**“利润奔跑，落袋为安”**

*   **核心算法**: **PnL 水位线 (High-Water Mark)**。
*   **持久化记忆**:
    *   系统利用 `GlobalVariable` 记录每笔订单**曾经达到过的最高浮盈**。
    *   **优势**: 即使 VPS 重启，EA 依然记得“这单曾经赚过 5%”，绝不会因为它回落到 1% 就把它当成新单子，防止逻辑重置导致的利润回吐。
*   **分级回撤 (Stepped Gap) - M15 策略**:
    根据水位线高度，动态调整回撤容忍度：
    *   **起步期 (PnL < 3.5%)**: Gap = `0.4%`。**策略**: 利润微薄，稍有风吹草动立即落袋。
    *   **发展期 (PnL < 6.0%)**: Gap = `0.6%`。**策略**: 趋势形成，忍受小幅震荡。
    *   **爆发期 (PnL > 6.0%)**: Gap = `1.0%`。**策略**: 放长线钓大鱼，博取超额收益。

### 4. 自动回补 (Auto Re-Entry) —— 【接力】
**“趋势接力，顺势而为”**

*   **设计理念**: 止盈出场不是结束，而是寻找更好入场位置的开始。
*   **适用场景**: 黄金 (Gold) / 趋势性品种 (v7.1+)。
*   **全链路鲁棒性 (Robustness)**:
    *   **手动单接管**: 即使是 Magic=0 的手动单，一旦被 EA 接管并止盈，也会被转化为标准的 EA 回补任务。
    *   **信号一致性**: 严格绑定 Signal ID。如果服务器推送新信号（反转）或 ID 变更，旧方向的所有补单任务瞬间作废，绝不逆势。
    *   **防止蔓延**: 
        *   **全局计数器**: 每波趋势（每个 Signal ID）严格限制补单次数（默认 **2次**）。
        *   **收敛逻辑**: 止盈 -> 补单 -> 再止盈 -> 再补单 -> 停止。防止在震荡末端无限循环。
*   **执行逻辑**:
    1.  **触发**: 仅在 **移动止盈 (Trailing Stop)** 触发离场时激活。
    2.  **监控**: 记录出场价，等待行情回调（**Gold 默认 0.12%**，约 $5.5 美金）。
    3.  **进场**: 价格到位且满足冷却时间（**60s**）后，自动以此前方向再次进场，并标记 `[ReEntry]`。

---

## 🚀 快速开始

1. **环境准备**:
   *   MT5 终端 (推荐 Exness / IC Markets)
   *   Windows VPS (建议延迟 < 5ms)
   *   在 `Tools -> Options -> Expert Advisors` 中添加 URL白名单: `https://<your-worker>.workers.dev`

2. **安装**:
   *   将对应板块的 `.mq5` 文件复制到 `MQL5/Experts/` 文件夹。
   *   编译代码。

3. **运行**:
   *   打开对应品种图表 (如 BTCUSDm, M15)。
   *   加载 EA。
   *   **必须检查**: 输入参数中的 `serverUrl` 和 `token` 是否正确。

## ⚠️ 风险提示

*   **高杠杆风险**: 本系统针对高杠杆优化，但高杠杆本身具有极高风险。请务必控制 `lotSize`。
*   **网络延迟**: PnL 追踪依赖本地网络，请确保 VPS 稳定。
*   **API 鉴权**: 确保 Token 只有你自己知道，防止他人恶意注入信号。
