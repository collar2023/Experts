# SignalPollerEA 商业级量化交易系统 (2026版)

本项目包含针对四大核心资产类别（Crypto, Gold, Forex, Index）定制开发的 MT5 智能交易系统 (EA)。系统基于 CF Workers 信号推送架构，集成了针对 **Exness 高杠杆环境** 优化的 **三大风控体系**。

---

## 📂 四大板块 (Modules)

每个板块的 EA 均针对该品种的波动特性、点差成本和交易时段进行了参数微调。

| 板块 | 目录 | 适用资产 | 特性优化 | 典型周期 |
| :--- | :--- | :--- | :--- | :--- |
| **BTC (Crypto)** | `/btc` | BTCUSD, ETHUSD | **M15高频平衡策略**。针对币圈巨大的点差和极快的反转，采用了 2000 点的保本缓冲和 1.5% 的紧缩止损。 | M15 |
| **Gold (XAU)** | `/gold` | XAUUSD (黄金) | **趋势突破策略**。针对黄金"单边猛、回调深"的特点，设置了 200 点保本缓冲，防止被洗盘。 | H1 / M30 |
| **Forex (外汇)** | `/forex` | EURUSD, GBPUSD | **稳健剥头皮**。30 点微利保本，适合低点差直盘。 | M5 / M15 |
| **Index (指数)** | `/index` | US30, NAS100 | **日内波段**。100 点缓冲，适应美股开盘时的高波动和跳空风险。 | M15 / H1 |

---

## 🛡️ 三大风控体系 (Risk Management Trinity)

本系统采用 **"硬风控 + 软风控 + PnL追踪"** 的三层防护网，特别针对 Exness 等高杠杆券商的 **零止损距离** 和 **滑点** 风险进行了深度适配。

### 1. 硬止损 (Hard Stop Loss) —— 灾难熔断器
*   **定义**: 在开仓瞬间发送给券商服务器的 `Stop Loss (SL)` 价格。
*   **作用**: **最后的防线**。仅在网络断连、服务器崩溃或行情瞬间跳空（Flash Crash）时触发。
*   **策略**:
    *   **BTC**: 设置为 `5.0%`。故意放宽，避免被日常波动误触发，将控制权交给更智能的软风控。
    *   **其他**: 根据 ATR 或固定点数设置。
*   **优势**: 即使你的电脑爆炸，这道防线依然在云端生效。

### 2. 软风控 (Soft Risk Logic) —— 智能操盘手
*   **定义**: EA 本地运行的 `OnTick` 实时逻辑，包含 **动态止损 (Dynamic SL)** 和 **保本 (Break Even)**。
*   **动态止损**:
    *   轻仓时允许 `1.5%` 回撤。
    *   重仓（Lot > 0.05）时自动收紧至 `1.0%`，保护本金。
*   **Exness 专用保本逻辑**:
    *   当浮盈达到阈值（如 BTC 1.2%）时，立即修改服务器端 SL。
    *   **关键优化**: 此时 SL 不是设在 `Entry Price`，而是设在 `Entry Price + ProtectBuffer`。
    *   **ProtectBuffer**: 预留利润以支付点差和佣金。
        *   BTC: `2000 Points` ($20)
        *   Gold: `200 Points` ($2.0)
    *   *解决了“保本离场反而亏手续费”的痛点。*

### 3. PnL 追踪 (PnL High-Water Mark) —— 利润收割机
*   **定义**: 系统核心的 **移动止盈 (Trailing Stop)** 算法。
*   **原理**: 记录每一笔订单的 **历史最高浮盈百分比 (Highest PnL%)**。注意，这不是当前浮盈，而是该订单**曾经达到过的最高点**。
*   **持久化机制 (Persistence)**:
    *   利用 `GlobalVariable` 将最高浮盈写入硬盘。
    *   **意义**: 即使 VPS 重启或 EA 重新加载，系统依然“记得”这笔单子曾经赚过 3%，绝不会因为它现在回落到 1% 就把它当成新单子处理。
*   **分级回撤逻辑 (Stepped Trailing Gap)**:
    根据 `Highest PnL` 的高度，动态调整允许的回撤空间 (Gap)：
    *   **Level 1 (起步)**: 最高浮盈 < 3.5% 时，Gap = `0.4%`。**目的**: 利润微薄，稍微回调就跑，落袋为安。
    *   **Level 2 (发展)**: 最高浮盈 < 6.0% 时，Gap = `0.6%`。**目的**: 趋势形成，适当放宽空间，忍受小幅震荡。
    *   **Level 3 (爆发)**: 最高浮盈 > 6.0% 时，Gap = `1.0%`。**目的**: 大趋势已经抓住，允许大幅回撤以博取超额收益。

---

## 🚀 快速开始

1. **环境准备**:
   *   MT5 终端 (推荐 Exness / IC Markets)
   *   Windows VPS (建议延迟 < 5ms)
   *   在 `Tools -> Options -> Expert Advisors` 中添加 URL白名单: `https://<your-worker>.workers.dev`

2. **安装**:
   *   将对应板块的 `.mq5` 文件复制到 `MQL5/Experts/` 文件夹。
   *   编译代码。

3. **运行**:
   *   打开对应品种图表 (如 BTCUSDm, M15)。
   *   加载 EA。
   *   **必须检查**: 输入参数中的 `serverUrl` 和 `token` 是否正确。

## ⚠️ 风险提示

*   **高杠杆风险**: 本系统针对高杠杆优化，但高杠杆本身具有极高风险。请务必控制 `lotSize`。
*   **网络延迟**: PnL 追踪依赖本地网络，请确保 VPS 稳定。
*   **API 鉴权**: 确保 Token 只有你自己知道，防止他人恶意注入信号。
